dnl YAZ Toolkit
dnl (c) Index Data 1994-2000
dnl See the file LICENSE for details.
dnl $Id: configure.in,v 1.21 2000-03-01 11:15:31 adam Exp $
AC_INIT(include/yaz/yaz-version.h)
AM_INIT_AUTOMAKE(yaz, 1.6)
dnl
dnl ------ Checking programs
AC_PROG_CC
AC_PROG_CPP
AC_PROG_INSTALL
AC_PROG_RANLIB
AC_CHECK_PROGS(have_sgml2txt,sgml2txt,no)
AC_CHECK_PROGS(have_sgml2latex,sgml2latex,no)
AC_CHECK_PROGS(have_sgml2html,sgml2html,no)
if test "$have_sgml2txt" = "no" -o "$have_sgml2latex" = "no" -o "$have_sgml2html" = "no"; then
	DOCMODULE=""
else
	DOCMODULE="doc"
fi
dnl 
dnl ----- YC: The Yaz Compiler
AC_SUBST(ASNMODULE)
AC_SUBST(ILLMODULE)
AC_SUBST(ILLLIB)
AC_ARG_ENABLE(yc,[  --disable-yc            use old encoders, i.e. disable YAZ ASN.1 Compiler], , enable_yc=yes)
if test "$enable_yc" = "yes"; then
	ASNMODULE="z39.50"
	ILLMODULE="ill"
	ILLLIB=../ill/libill.a
	ASN_MAKEFILES="z39.50/Makefile ill/Makefile"
	cp -f include/yaz/z-proto.h include/yaz/proto.h
else
	ILLMODULE=""
	ASNMODULE=asn
	ILLLIB=""
	ASN_MAKEFILES="asn/Makefile"
	cp -f include/yaz/prt-proto.h include/yaz/proto.h
fi
dnl
dnl ----- Sockets
checkBoth=0
AC_CHECK_FUNC(connect)
if test "$ac_cv_func_connect" = "no"; then
	AC_CHECK_LIB(socket, main, LIBS="$LIBS -lsocket", checkBoth=1)
fi
if test "$checkBoth" = "1"; then
	oldLibs=$LIBS
	LIBS="$LIBS -lsocket -lnsl"
	AC_CHECK_FUNC(accept, , [LIBS=$oldLibs])
fi
AC_CHECK_FUNC(gethostbyname, , AC_CHECK_LIB(nsl, main, [LIBS="$LIBS -lnsl"]))
dnl
dnl ------ GNU Readline
AC_CHECK_LIB(readline, readline, [LIBS="$LIBS -lreadline"])
if test "$ac_cv_lib_readline_readline" = "no"; then
	AC_CHECK_LIB(readline, readline, [LIBS="$LIBS -lreadline -ltermcap"])
fi
AC_CHECK_LIB(history, add_history, [LIBS="$LIBS -lhistory"])
if test "$ac_cv_lib_readline_readline" = "yes"; then
	AC_CHECK_HEADERS(readline/readline.h readline/history.h)
fi
dnl
dnl ------ tcpd
AC_ARG_ENABLE(tcpd,[  --enable-tcpd           enable TCP wrapper for server if available])
if test "$enable_tcpd" = "yes"; then
	AC_MSG_CHECKING(for working tcpd.h)
	oldLibs=$LIBS
	LIBS="$LIBS -lwrap -lnsl"
	AC_TRY_LINK([#include <syslog.h>
	#include <tcpd.h>
	int allow_severity = LOG_INFO;
	int deny_severity = LOG_WARNING;],
	[struct request_info request_info; int i;
	i = hosts_access(&request_info);],tcpd_ok=1, tcpd_ok=0)
	if test "$tcpd_ok" = "0"; then
		AC_MSG_RESULT(no)
		LIBS=$oldLibs
	else
		AC_MSG_RESULT(yes)
		AC_DEFINE(HAVE_TCPD_H)
	fi
fi
dnl
dnl ------ Headers
AC_STDC_HEADERS
if test "$ac_cv_header_stdc" = "no"; then
	AC_MSG_WARN(Your system doesn't seem to support ANSI C)
fi
dnl
dnl ------ Threads
AC_ARG_ENABLE(threads, [  --enable-threads        enable threads if available])
if test "$enable_threads" = "yes"; then
	AC_CHECK_HEADERS(pthread.h threads.h)
	AC_CHECK_FUNC(pthread_mutex_lock)
	if test "$ac_cv_func_pthread_mutex_lock" = "no"; then
		AC_CHECK_LIB(pthread, main)
	fi
	AC_DEFINE(_REENTRANT)
fi
dnl
SUBDIRS_VAR="util odr $ASNMODULE $ILLMODULE zutil comstack ccl tab retrieval server include lib client ztest $DOCMODULE"
AC_SUBST(SUBDIRS_VAR)
dnl
dnl ------ Makefiles
dnl
AC_OUTPUT(Makefile util/Makefile odr/Makefile z39.50/Makefile asn/Makefile ill/Makefile zutil/Makefile comstack/Makefile ccl/Makefile tab/Makefile retrieval/Makefile server/Makefile include/Makefile include/yaz/Makefile lib/Makefile client/Makefile ztest/Makefile doc/Makefile)
